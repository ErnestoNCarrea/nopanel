#!/bin/bash

if [[ -z "$NOPANEL_VERSION" ]]; then
    echo "This file should not be called without the proper environment. Use nopanel CLI instead."
    exit 1
fi

nopanel_init() {
    nopanel_command_echo "Initializing noPanel version $NOPANEL_VERSION"

    mkdir -p $NOPANEL_STATE $NOPANEL_ETC $NOPANEL_LOG
    chmod 0750 $NOPANEL_STATE $NOPANEL_ETC $NOPANEL_LOG

    mkdir -p $NOPANEL_ETC/users

    # Initialize missing configuration files to empty json
    for FILE in nopanel.json modules.json users.json
    do
        [[ -f "$NOPANEL_ETC/$FILE" ]] || echo '{}' >> "$NOPANEL_ETC/$FILE"
    done

    # Add a general group for normal users created by noPanel
    if [ -z "$(grep ^nopanel-users: /etc/group)" ]; then
        groupadd --system "nopanel-users"
    fi

    nopanel_command_return 'ok' 'noPanel ready'
}

# If this files is _not_ being sourced, act immediately
if [ "${BASH_SOURCE[0]}" == "${0}" ]; then
    npctl $@
fi